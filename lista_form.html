<!DOCTYPE html>
<html lang="es-ES">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõí ¬°Lista para comprar</title>
    <!-- CSS de Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <!-- CSS personalizado -->
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" href="lista_form.css">
</head>

<body class="p-3">
    <!-- Bot√≥n para volver al inicio -->
    <button class="btn btn-outline-primary mb-3" onclick="window.location.href='index.html'">
        ‚Üê Volver al Inicio
    </button>

    <h1>üõí Mi Lista de Compras</h1>
    <div class="mb-3">
        <label>Nombre de la Lista: <input type="text" id="listaNombre" class="form-control"></label>
        <label>Presupuesto (‚Ç¨): <input type="number" id="presupuestoInicial" value="10"
                class="form-control mt-2"></label>
        <input type="hidden" id="indiceLista" value="">
        <button class="btn btn-success mt-3" onclick="guardarLista()">Guardar Lista</button>
    </div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unitario (‚Ç¨)</th>
                <th>Precio Total (‚Ç¨)</th>
                <th>Ok</th>
                <th>Acci√≥n</th>
            </tr>
        </thead>
        <tbody id="tablaItems">
        </tbody>
    </table>
    <button class="btn btn-primary" onclick="agregarItem()">Agregar Producto</button>
    <div class="mt-3">
        <p>Total General: ‚Ç¨ <span id="totalGeneral">0.00</span></p>
        <p>Saldo Restante: ‚Ç¨ <span id="saldoRestante">0.00</span></p>
    </div>

    <script>
        let items = [];

        // Obtener par√°metro de URL
        function obtenerParametroURL(nombre) {
            const params = new URLSearchParams(window.location.search);
            return params.get(nombre);
        }

        // Cargar lista si se est√° editando
        function cargarListaParaEditar() {
            const index = obtenerParametroURL('index');
            if (index !== null) {
                const listasJSON = localStorage.getItem('listas');
                if (listasJSON) {
                    const listas = JSON.parse(listasJSON);
                    const lista = listas[index];
                    if (lista) {
                        document.getElementById('listaNombre').value = lista.nombre || '';
                        document.getElementById('presupuestoInicial').value = lista.presupuesto || 10;
                        items = lista.items || [];
                        document.getElementById('indiceLista').value = index;
                        renderizarTabla();
                        calcularTotales();
                    }
                }
            }
        }

        // Renderizar tabla seg√∫n items
        function renderizarTabla() {
            const tbody = document.getElementById('tablaItems');
            tbody.innerHTML = '';
            items.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${item.nombre}" onchange="actualizarItem(${index}, 'nombre', this.value)"></td>
                    <td><input type="number" value="${item.cantidad}" min="1" onchange="actualizarItem(${index}, 'cantidad', this.value)"></td>
                    <td><input type="number" step="0.01" value="${item.precio === 0 ? '' : item.precio}" min="0" onchange="actualizarItem(${index}, 'precio', this.value)">
</td>
                    <td id="precioTotal${index}">${(item.cantidad * item.precio).toFixed(2)}</td>
                    <td><input type="checkbox" ${item.ok ? 'checked' : ''} onchange="actualizarItem(${index}, 'ok', this.checked)"></td>
                    <td><button class="btn btn-sm btn-danger" onclick="eliminarItem(${index})">Eliminar</button></td>
                `;
            });
        }

        function agregarItem() {
            items.push({ nombre: '', cantidad: 1, precio: 0, ok: false });
            renderizarTabla();
        }

        function actualizarItem(index, campo, valor) {
            if (campo === 'cantidad' || campo === 'precio') {
                let num = parseFloat(valor);
                if (isNaN(num)) num = 0;
                valor = num;
            }
            items[index][campo] = valor;
            const precioTotalElem = document.getElementById(`precioTotal${index}`);
            if (precioTotalElem) {
                const total = items[index].cantidad * items[index].precio;
                precioTotalElem.textContent = total.toFixed(2);
            }
            calcularTotales();
        }

        function eliminarItem(index) {
            items.splice(index, 1);
            renderizarTabla();
            calcularTotales();
        }

        function calcularTotales() {
            let total = 0;
            items.forEach(item => {
                if (item.ok) {
                    total += item.cantidad * item.precio;
                }
            });
            const presupuesto = parseFloat(document.getElementById('presupuestoInicial').value) || 0;
            document.getElementById('totalGeneral').textContent = total.toFixed(2);
            document.getElementById('saldoRestante').textContent = (presupuesto - total).toFixed(2);
        }

        function guardarLista() {
            const nombre = document.getElementById('listaNombre').value.trim();
            if (!nombre) {
                alert('Por favor, ingresa un nombre para la lista.');
                return;
            }
            const presupuesto = parseFloat(document.getElementById('presupuestoInicial').value) || 0;
            const dataHora = new Date().toLocaleString('es-ES', {
                timeZone: 'Europe/Madrid',
                hour: "2-digit",
                minute: "2-digit",
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
            });

            const lista = { nombre, dataHora, presupuesto, items };

            let listas = JSON.parse(localStorage.getItem('listas')) || [];
            const indice = document.getElementById('indiceLista').value;

            if (indice) {
                listas[indice] = lista;  // Actualizar lista existente
            } else {
                listas.push(lista);      // Agregar nueva lista
            }

            localStorage.setItem('listas', JSON.stringify(listas));
            alert('¬°Lista guardada!');
            window.location.href = 'index.html';
        }

        // Inicializar al cargar la p√°gina
        window.onload = function () {
            cargarListaParaEditar();
        };
    </script>
</body>

</html>